INPUTS:
  core_shares                 # 底仓股数（不动）
  t_max_shares                # 机动仓最大股数（用于做T）
  t_step_shares               # 每次T操作股数（<= t_max_shares）
  max_round_trips_per_day     # 每日最多回合数（1~2）
  daily_loss_limit            # 日内最大亏损阈值（到达即停止）
  cooldown_minutes            # 交易冷却时间
  open_buffer_minutes         # 开盘禁做时间（常用 30；事件日 60）

STREAM DATA:
  price, high, low, volume
  vwap
  time
  spread, orderbook_depth     # 如果可用
  event_flag                  # 是否事件日（可由日历/财报表预置）

STATE:
  day_type = UNKNOWN
  round_trips_done = 0
  daily_pnl = 0
  last_trade_time = -INF
  t_inventory = 0             # 当前机动仓持有（正=加了未减，负=减了未回补）

# ---------- Day Type Classification ----------
FUNCTION classify_day_type():
  # 使用开盘后 N 分钟的行为判断（例如 30~60 分钟）
  OR_high = high_of_first_N_minutes
  OR_low  = low_of_first_N_minutes

  trend_score = 0
  chop_score  = 0

  # 1) VWAP 斜率一致性（单边）
  if slope(vwap, last_M_minutes) strong and
     price mostly on one side of vwap and
     pullbacks shallow:
       trend_score += 1

  # 2) 突破/失败次数（震荡）
  if many_failed_breakouts(OR_high, OR_low) or
     frequent_cross(vwap) and
     mean_reversion_moves:
       chop_score += 1

  # 3) 事件标记优先
  if event_flag == TRUE:
     return EVENT

  if trend_score >= threshold:
     return TREND
  if chop_score >= threshold:
     return CHOP
  return CHOP   # 默认把不明确日当成震荡日（更保守可设 UNKNOWN 不做）

# ---------- Global Risk Gate ----------
FUNCTION risk_gate_pass():
  if daily_pnl <= -daily_loss_limit:
     return FALSE
  if time < market_open + open_buffer_minutes:
     return FALSE
  if (time - last_trade_time) < cooldown_minutes:
     return FALSE
  if spread_abnormal(spread) or depth_thin(orderbook_depth):
     return FALSE
  if round_trips_done >= max_round_trips_per_day:
     return FALSE
  return TRUE

# ---------- Trading Logic by Day Type ----------
FUNCTION trade_logic():
  if day_type == UNKNOWN:
     day_type = classify_day_type()

  if risk_gate_pass() == FALSE:
     return

  # Common thresholds (conceptual):
  dev = price - vwap
  dev_norm = dev / intraday_vol_estimate()         # 用ATR/标准差/历史分位数等
  near_OR_high = is_near(price, OR_high, band)
  near_OR_low  = is_near(price, OR_low, band)

  # ---- CHOP DAY: mean reversion around vwap / range edges ----
  if day_type == CHOP:
     # Buy low: 下沿或显著低于VWAP
     if (dev_norm <= -buy_threshold OR near_OR_low) AND t_inventory <= 0:
        buy_shares = min(t_step_shares, t_max_shares - max(0, t_inventory))
        place_limit_buy(buy_shares, price_improve())
        t_inventory += buy_shares
        last_trade_time = time

     # Sell high: 上沿或显著高于VWAP
     if (dev_norm >= sell_threshold OR near_OR_high) AND t_inventory >= 0:
        sell_shares = min(t_step_shares, t_max_shares - max(0, -t_inventory))
        place_limit_sell(sell_shares, price_improve())
        t_inventory -= sell_shares
        last_trade_time = time

     # Round trip accounting: 一次加一次减完成视为一个回合
     if completed_round_trip():
        round_trips_done += 1

     # Stop condition for T-lot if breakout holds (range regime change)
     if breakout_and_hold(OR_high) OR breakdown_and_hold(OR_low):
        reduce_or_stop_T_trading()

  # ---- TREND DAY: trade only WITH trend (pullback add / extension trim) ----
  if day_type == TREND:
     trend_dir = sign(slope(vwap, last_M_minutes))  # +1 up, -1 down

     if trend_dir == +1:
        # Pullback add near vwap
        if dev_norm <= -pullback_threshold AND price_above_key_support() AND t_inventory <= 0:
           buy_shares = min(t_step_shares, t_max_shares - max(0, t_inventory))
           place_limit_buy(buy_shares, price_improve())
           t_inventory += buy_shares
           last_trade_time = time

        # Extension trim when far above vwap
        if dev_norm >= extension_threshold AND t_inventory > 0:
           sell_shares = min(t_step_shares, t_inventory)
           place_limit_sell(sell_shares, price_improve())
           t_inventory -= sell_shares
           last_trade_time = time

     if trend_dir == -1:
        # 只做“反弹减/回落回补”的对称逻辑（或直接禁做，取决于你是否做空）
        disable_or_mirror_for_short_only()

     if completed_round_trip():
        round_trips_done += 1

  # ---- EVENT DAY: widen thresholds, delay start, smaller size ----
  if day_type == EVENT:
     if time < market_open + event_open_buffer_minutes:  # 例如 60
        return
     # 用更大的阈值、更小的 t_step_shares、更严格的风控
     apply_event_mode_parameters()
     execute_CHOP_like_logic_with_stricter_rules()

# Main loop:
on_market_data_update():
  update_indicators()
  trade_logic()
